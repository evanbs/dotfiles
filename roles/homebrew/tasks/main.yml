---
- name: Install build dependencies for Linuxbrew
  package:
    name:
      - build-essential
      - procps
      - file
      - curl
      - git
      - ca-certificates
      - xz-utils
      - gcc
      - make
    state: present
  when: ansible_os_family == 'Debian'

- name: Ensure linuxbrew base directory exists
  file:
    path: "/home/linuxbrew"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure Homebrew prefix directory exists with dev ownership
  file:
    path: "{{ brew_prefix }}"
    state: directory
    owner: "{{ dev_username }}"
    group: "{{ dev_username }}"
    mode: '0755'
    recurse: yes

- name: Install Linuxbrew (Homebrew) if missing
  become_user: "{{ dev_username }}"
  shell: |
    set -euo pipefail
    if [ ! -x "{{ brew_prefix }}/bin/brew" ]; then
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
  args:
    executable: /bin/bash

- name: Add brew shellenv to profile
  lineinfile:
    path: "/home/{{ dev_username }}/.bashrc"
    line: 'eval "$({{ brew_prefix }}/bin/brew shellenv)"'
    create: yes
  become_user: "{{ dev_username }}"

- name: Add brew shellenv to zprofile
  lineinfile:
    path: "/home/{{ dev_username }}/.zprofile"
    line: 'eval "$({{ brew_prefix }}/bin/brew shellenv)"'
    create: yes
  become_user: "{{ dev_username }}"

- name: Install base packages via brew
  community.general.homebrew:
    name:
      - git
      - git-delta
      - zsh
      - starship
    state: present
    path: "{{ brew_prefix }}/bin"
  become_user: "{{ dev_username }}"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
    HOMEBREW_PREFIX: "{{ brew_prefix }}"

- name: Ensure brew is in PATH for subsequent tasks
  set_fact:
    brew_bin: "{{ brew_prefix }}/bin/brew"

- name: Disable brew analytics
  become_user: "{{ dev_username }}"
  shell: "{{ brew_prefix }}/bin/brew analytics off"
  args:
    executable: /bin/bash

- name: Update Homebrew formulas
  become_user: "{{ dev_username }}"
  community.general.homebrew:
    update_homebrew: yes
    path: "{{ brew_prefix }}/bin"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
    HOMEBREW_PREFIX: "{{ brew_prefix }}"

- name: Install developer CLI tools via brew
  community.general.homebrew:
    name: "{{ brew_packages }}"
    state: present
    path: "{{ brew_prefix }}/bin"
  become_user: "{{ dev_username }}"
  environment:
    PATH: "{{ brew_prefix }}/bin:{{ ansible_env.PATH }}"
    HOMEBREW_PREFIX: "{{ brew_prefix }}"

- name: Copy Brewfile to user home
  copy:
    src: "{{ role_path }}/files/Brewfile"
    dest: "/home/{{ dev_username }}/.Brewfile"
    owner: "{{ dev_username }}"
    mode: '0644'
  become_user: "{{ dev_username }}"

- name: Install packages from Brewfile
  become_user: "{{ dev_username }}"
  shell: "{{ brew_prefix }}/bin/brew bundle --file=/home/{{ dev_username }}/.Brewfile"
  args:
    executable: /bin/bash
  register: brew_bundle_result
  changed_when: "'Installing' in brew_bundle_result.stdout"


