---
- name: Check if Bun is already installed
  become_user: "{{ dev_username }}"
  shell: "{{ brew_prefix }}/bin/brew list bun >/dev/null 2>&1"
  args:
    executable: /bin/bash
  register: bun_check
  failed_when: false
  changed_when: false

- name: Install Bun via Homebrew
  become_user: "{{ dev_username }}"
  shell: "{{ brew_prefix }}/bin/brew install oven-sh/bun/bun"
  args:
    executable: /bin/bash
  when: bun_check.rc != 0
  register: bun_install_result

- name: Display Bun installation output
  debug:
    var: bun_install_result
  when: bun_check.rc != 0 and bun_install_result is defined

- name: Create Bun cache directory
  file:
    path: "/home/{{ dev_username }}/.bun/install/cache"
    state: directory
    owner: "{{ dev_username }}"
    group: "{{ dev_username }}"
    mode: '0755'

- name: Verify Bun installation
  become_user: "{{ dev_username }}"
  shell: "{{ brew_prefix }}/bin/bun --version"
  args:
    executable: /bin/bash
  register: bun_version
  changed_when: false

- name: Display Bun version
  debug:
    msg: "Bun {{ bun_version.stdout }} installed successfully"
